<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">M</span>,<span class="var type1" id="S3T1U4">Tsfc</span>,<span class="var type1" id="S4T1U5">Lin</span>,<span class="var type1" id="S5T1U6">LinZ</span>,<span class="var type1" id="S6T1U7">Lout</span>,<span class="var type1" id="S7T1U8">sensible</span>,<span class="var type1" id="S8T1U9">latent</span>,<span class="var type1" id="S9T1U10">G</span>,<span class="var type1" id="S10T1U11">opt_out</span>]=<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">    solve_ebalance(<span class="var type1" id="S11T1U14">Lin_coarse</span>,<span class="var type1" id="S12T1U15">q_coarse</span>,<span class="var type1" id="S13T1U16">Zdiff</span>,<span class="var type1" id="S14T1U17">T_coarse</span>,<span class="var type1" id="S15T1U18">T_fine</span>,<span class="var type1" id="S16T1U19">Vf</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line">    <span class="var type1" id="S17T1U20">albedo</span>,<span class="var type1" id="S18T1U21">Sin</span>,<span class="var type1" id="S19T1U22">windspd</span>,<span class="var type1" id="S20T1U23">pres_coarse</span>,<span class="var type1" id="S21T1U24">pres_fine</span>,<span class="var type1" id="S22T2U25">fast_flag</span>,<span class="var type1" id="S23T3U26">mode</span>,<span class="var type1" id="S24T4U27">varargin</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%solves energy balance for surface temperature for scalar (point) values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% Lin_coarse - coarse incoming longwave, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% q_coarse - coarse specific humidity, kg/kg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% T_coarse - coarse temp, K</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% Zdiff - elevation diff between coarse and fine scale dem from Lin_coarse</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% T_fine - downscaled air temperatures, K</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% Vf - view factor, 0-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% albedo - debris albedo, 0-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% Sin - dowscaled global shortwave, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% windspd -  wind speed, m/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% pres_coarse - coarse pressure, kPa</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% pres_fine - fine scale pressure, kPa</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% fast flag - true - only solve for M; false - solve for all outputs; only set for 'normal'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% mode, either normal - snow/ice melt;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% debris - ice melt under debris;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% or debris depth - solve for debris depth</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% then follow with req'd inputs:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% for 'normal';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%   tau - canopy transmissivity, 0-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">%   cc - canopy cover fraction, 0-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">% for 'debris'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%   % d - debris cover depth, m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% for 'debris depth'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">%   Tsfc - surface temp, K</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% NOTE in the mex version two inputs must always be given after mode since</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">% varargin is not implemented. Thus for debris of debris depth, provide a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% zero</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">% output:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">% M- sum of melt energy, should be around 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% Tsfc - debris surface temperature, K (solved for w/ energy balance or</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">% same as supplied)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">% Lin - incoming longwave, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% LinZ - incoming longwave, not corrected for veg or surrounding terrain,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">% W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">% Lout - outgoing longwave, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">% sensible, sensible heat flux, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% latent, latent heat flux, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">% G, conductive heat flux, W/m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">% optional, if mode is 'debris depth'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">% opt_out - d, debris depth, m, NaN otherwise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% Constants</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T1:U24"><span class="var type1" id="S25T1U30">sig</span>=<span class="mxinfo " id="T1:U26">single(5.6704E-8)</span></span>;<span class="comment">% Stefan Boltzmann</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T1:U27"><span class="mxinfo " id="T1:U28"><span class="var type1" id="S27T5U37">emissivity</span>.emd</span>=<span class="mxinfo " id="T1:U30">single(0.94)</span></span>;<span class="comment">% Emissivity of debris</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T1:U31"><span class="mxinfo " id="T1:U32"><span class="var type1" id="S27T5U45">emissivity</span>.ems</span>=<span class="mxinfo " id="T1:U34">single(0.99)</span></span>;<span class="comment">% Emissivity of snow</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T1:U35"><span class="mxinfo " id="T1:U36"><span class="var type1" id="S27T5U53">emissivity</span>.emc</span>=<span class="mxinfo " id="T1:U38">single(0.98)</span></span>;<span class="comment">% Emissivity of canopy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="mxinfo " id="T1:U39"><span class="var type1" id="S28T1U60">Cp</span>=<span class="mxinfo " id="T1:U41">single(1010)</span></span>; <span class="comment">% specific heat air, J/(kg deg)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="mxinfo " id="T1:U42"><span class="var type1" id="S29T1U66">Cs</span>=<span class="mxinfo " id="T1:U44">single(<span class="mxinfo " id="T6:U45">2.09e3</span>)</span></span>; <span class="comment">%specific heat of ice, J deg C^-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="mxinfo " id="T1:U46"><span class="var type1" id="S30T1U72">xLs</span>=<span class="mxinfo " id="T1:U48">single(2.834e6)</span></span>; <span class="comment">%latent heat of sublimation, J/(kg deg)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="mxinfo " id="T1:U49"><span class="var type1" id="S31T1U78">pres_0</span>=<span class="mxinfo " id="T1:U51">single(101.325)</span></span>; <span class="comment">% sea level pressure kPa.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo " id="T1:U52"><span class="var type1" id="S32T1U84">rho_air</span>=<span class="mxinfo " id="T1:U54">single(1.29).*(<span class="mxinfo " id="T1:U55"><span class="var type1" id="S21T1U91">pres_fine</span>./<span class="var type1" id="S31T1U92">pres_0</span></span>)</span></span>;<span class="comment">%alt adj. density air,kg/m^3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%convert kPa to Pa</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T1:U58"><span class="var type1" id="S21T1U95">pres_fine</span>=<span class="mxinfo " id="T1:U60"><span class="var type1" id="S21T1U97">pres_fine</span>*1000</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T1:U62"><span class="var type1" id="S33T1U101">ht_wind_obs</span>=<span class="mxinfo " id="T1:U64">single(2)</span></span>; <span class="comment">%m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T1:U65"><span class="var type1" id="S34T1U107">xkappa</span>=<span class="mxinfo " id="T1:U67">single(0.41)</span></span>;<span class="comment">% von Karmans constant</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T1:U68"><span class="var type1" id="S35T1U113">gravity</span>=<span class="mxinfo " id="T1:U70">single(9.8)</span></span>; <span class="comment">%m/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T1:U71"><span class="var type1" id="S36T1U119">z_0d</span>=<span class="mxinfo " id="T1:U73">single(<span class="mxinfo " id="T6:U74">0.05</span>)</span></span>; <span class="comment">%debris roughness length, m, Lejeune and other, 2013</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T1:U75"><span class="var type1" id="S37T1U125">z_0s</span>=<span class="mxinfo " id="T1:U77">single(<span class="mxinfo " id="T6:U78">0.0005</span>)</span></span>; <span class="comment">%snow roughness length, m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="mxinfo " id="T1:U79"><span class="var type1" id="S38T1U131">Kd</span>=<span class="mxinfo " id="T1:U81">single(1.0)</span></span>; <span class="comment">%W/(m deg K), debris avg from Schauwecker and other, 2015</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%air vapor pressure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">[<span class="mxinfo " id="T1:U82">~</span>,<span class="var type1" id="S39T1U139">ea</span>]=<span class="fcn" id="F284N6:B141">downscaleDewpoint</span>(<span class="var type1" id="S20T1U142">pres_coarse</span>,<span class="var type1" id="S12T1U143">q_coarse</span>,<span class="var type1" id="S14T1U144">T_coarse</span>,<span class="var type1" id="S15T1U145">T_fine</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">%convert kPa to Pa</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="mxinfo " id="T1:U88"><span class="var type1" id="S39T1U148">ea</span>=<span class="mxinfo " id="T1:U90"><span class="var type1" id="S39T1U150">ea</span>*1000</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="mxinfo " id="T1:U92"><span class="var type1" id="S41T1U154">Tf</span>=<span class="mxinfo " id="T1:U94">273.15*ones(size(<span class="var type1" id="S11T1U161">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;<span class="comment">%K, freezing temp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="mxinfo " id="T1:U96"><span class="var type1" id="S2T1U165">M</span>=<span class="mxinfo " id="T1:U98">NaN(size(<span class="var type1" id="S11T1U170">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="mxinfo " id="T1:U100"><span class="var type1" id="S4T1U174">Lin</span>=<span class="mxinfo " id="T1:U102">NaN(size(<span class="var type1" id="S11T1U179">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="mxinfo " id="T1:U104"><span class="var type1" id="S5T1U183">LinZ</span>=<span class="mxinfo " id="T1:U106">NaN(size(<span class="var type1" id="S11T1U188">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="mxinfo " id="T1:U108"><span class="var type1" id="S6T1U192">Lout</span>=<span class="mxinfo " id="T1:U110">NaN(size(<span class="var type1" id="S11T1U197">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="mxinfo " id="T1:U112"><span class="var type1" id="S7T1U201">sensible</span>=<span class="mxinfo " id="T1:U114">NaN(size(<span class="var type1" id="S11T1U206">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="mxinfo " id="T1:U116"><span class="var type1" id="S8T1U210">latent</span>=<span class="mxinfo " id="T1:U118">NaN(size(<span class="var type1" id="S11T1U215">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="mxinfo " id="T1:U120"><span class="var type1" id="S9T1U219">G</span>=<span class="mxinfo " id="T1:U122">NaN(size(<span class="var type1" id="S11T1U224">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="mxinfo " id="T2:U124"><span class="var type1" id="S45T2U228">normalflag</span>=<span class="mxinfo " id="T2:U126">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="mxinfo " id="T2:U127"><span class="var type1" id="S47T2U233">ddflag</span>=<span class="mxinfo " id="T2:U129">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%debris case</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="mxinfo " id="T1:U130"><span class="var type1" id="S48T1U238">z_0</span>=<span class="var type1" id="S36T1U239">z_0d</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="mxinfo " id="T1:U133"><span class="var type1" id="S3T1U242">Tsfc</span>=<span class="mxinfo " id="T1:U135">NaN(size(<span class="var type1" id="S11T1U247">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="mxinfo " id="T1:U137"><span class="var type1" id="S49T1U251">tau</span>=<span class="mxinfo " id="T1:U139">zeros(size(<span class="var type1" id="S11T1U256">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="mxinfo " id="T1:U141"><span class="var type1" id="S51T1U260">cc</span>=<span class="mxinfo " id="T1:U143">zeros(size(<span class="var type1" id="S11T1U265">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="mxinfo " id="T1:U145"><span class="var type1" id="S52T1U269">ebalance_opt_arg</span>=<span class="mxinfo " id="T1:U147">NaN(size(<span class="var type1" id="S11T1U274">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="mxinfo " id="T6:U149"><span class="keyword">switch</span> <span class="var type1" id="S23T3U277">mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'normal'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">        <span class="mxinfo " id="T1:U151"><span class="var type1" id="S49T1U282">tau</span>=<span class="mxinfo " id="T1:U153"><span class="var type1" id="S24T4U284">varargin</span>{1}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">        <span class="mxinfo " id="T1:U155"><span class="var type1" id="S51T1U288">cc</span>=<span class="mxinfo " id="T1:U157"><span class="var type1" id="S24T4U290">varargin</span>{2}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        <span class="mxinfo " id="T1:U159"><span class="var type1" id="S48T1U294">z_0</span>=<span class="var type1" id="S37T1U295">z_0s</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="mxinfo " id="T2:U162"><span class="var type1" id="S45T2U298">normalflag</span>=<span class="mxinfo " id="T2:U164">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'debris'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="mxinfo " id="T1:U165"><span class="var type1" id="S54T1U305">d</span>=<span class="mxinfo " id="T1:U167"><span class="var type1" id="S24T4U307">varargin</span>{1}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="mxinfo " id="T1:U169"><span class="var type1" id="S52T1U311">ebalance_opt_arg</span>=<span class="var type1" id="S54T1U312">d</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'debris depth'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">        <span class="mxinfo " id="T1:U172"><span class="var type1" id="S3T1U317">Tsfc</span>=<span class="mxinfo " id="T1:U174"><span class="var type1" id="S24T4U319">varargin</span>{1}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">        <span class="mxinfo " id="T1:U176"><span class="var type1" id="S52T1U323">ebalance_opt_arg</span>=<span class="var type1" id="S3T1U324">Tsfc</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">        <span class="mxinfo " id="T2:U179"><span class="var type1" id="S47T2U327">ddflag</span>=<span class="mxinfo " id="T2:U181">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="keyword">otherwise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">        error(<span class="string">'mode must be normal, debris, or debris depth'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="comment">%compute turbulent coef</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="mxinfo " id="T1:U182"><span class="var type1" id="S56T1U337">De_h</span>=<span class="mxinfo " id="T1:U184">(<span class="mxinfo " id="T1:U185"><span class="var type1" id="S34T1U342">xkappa</span>.^2.*<span class="var type1" id="S19T1U344">windspd</span></span>)./(<span class="mxinfo " id="T1:U188">(<span class="mxinfo " id="T1:U189">log(<span class="mxinfo " id="T1:U190"><span class="var type1" id="S33T1U351">ht_wind_obs</span>./<span class="var type1" id="S48T1U352">z_0</span></span>)</span>).^2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="comment">%additional stability function constants</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="mxinfo " id="T1:U193"><span class="var type1" id="S58T1U356">C1</span>=<span class="mxinfo " id="T1:U195"><span class="mxinfo " id="T1:U196">5.3.*9.4.*<span class="mxinfo " id="T1:U197">(<span class="mxinfo " id="T1:U198"><span class="var type1" id="S34T1U365">xkappa</span>./(<span class="mxinfo " id="T1:U200">log(<span class="mxinfo " id="T1:U201"><span class="var type1" id="S33T1U370">ht_wind_obs</span>./<span class="var type1" id="S48T1U371">z_0</span></span>)</span>)</span>).^2</span></span>.*<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="mxinfo " id="T1:U204">sqrt(<span class="mxinfo " id="T1:U205"><span class="var type1" id="S33T1U376">ht_wind_obs</span>./<span class="var type1" id="S48T1U377">z_0</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="mxinfo " id="T1:U208"><span class="var type1" id="S60T1U380">C2</span>=<span class="mxinfo " id="T1:U210"><span class="mxinfo " id="T1:U211"><span class="var type1" id="S35T1U383">gravity</span>.*<span class="var type1" id="S33T1U384">ht_wind_obs</span></span>./(<span class="mxinfo " id="T1:U214"><span class="var type1" id="S15T1U387">T_fine</span>.*<span class="mxinfo " id="T1:U216"><span class="var type1" id="S19T1U389">windspd</span>.^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo " id="T1:U218"><span class="var type1" id="S61T1U393">B1</span>=<span class="mxinfo " id="T1:U220">9.4.*<span class="var type1" id="S60T1U396">C2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="mxinfo " id="T1:U222"><span class="var type1" id="S62T1U399">B2</span>=<span class="mxinfo " id="T1:U224"><span class="var type1" id="S58T1U401">C1</span>.*<span class="mxinfo " id="T1:U226">sqrt(<span class="var type1" id="S60T1U404">C2</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="mxinfo " id="T1:U228"><span class="var type1" id="S10T1U407">opt_out</span>=<span class="mxinfo " id="T1:U230">NaN(size(<span class="var type1" id="S11T1U412">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">% if ~isnan(albedo)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S47T2U416">ddflag</span> <span class="comment">% &amp;&amp; ~isnan(Tsfc(:)) % Tsfc given</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">        [<span class="var type1" id="S54T1U420">d</span>,<span class="var type1" id="S5T1U421">LinZ</span>,<span class="var type1" id="S6T1U422">Lout</span>,<span class="var type1" id="S7T1U423">sensible</span>,<span class="var type1" id="S9T1U424">G</span>]=<span class="fcn" id="F453N12:B426">solve_debris_depth</span>(<span class="var type1" id="S11T1U427">Lin_coarse</span>,<span class="var type1" id="S13T1U428">Zdiff</span>,<span class="var type1" id="S15T1U429">T_fine</span>,<span class="var type1" id="S16T1U430">Vf</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">            <span class="var type1" id="S17T1U431">albedo</span>,<span class="var type1" id="S18T1U432">Sin</span>,<span class="var type1" id="S3T1U433">Tsfc</span>,<span class="var type1" id="S25T1U434">sig</span>,<span class="mxinfo " id="T1:U246"><span class="var type1" id="S27T5U436">emissivity</span>.ems</span>,<span class="var type1" id="S32T1U438">rho_air</span>,<span class="var type1" id="S28T1U439">Cp</span>,<span class="var type1" id="S56T1U440">De_h</span>,<span class="var type1" id="S38T1U441">Kd</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">        <span class="mxinfo " id="T1:U252"><span class="var type1" id="S10T1U444">opt_out</span>=<span class="var type1" id="S54T1U445">d</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U255">~<span class="var type1" id="S47T2U448">ddflag</span></span> <span class="comment">%not solving for debris depth</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T2:U257">~<span class="var type1" id="S22T2U452">fast_flag</span></span> <span class="comment">% solve w/ correct outputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">            <span class="mxinfo " id="T1:U259"><span class="var type1" id="S64T1U455">x0</span>=single(<span class="var type1" id="S15T1U458">T_fine</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="comment">%             y0=ebalance(x0,Lin_coarse,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="comment">%                 Zdiff,T_fine,Vf,albedo,pres_fine,Sin,ea,sig,emissivity,Cp,xLs,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="comment">%                 rho_air,De_h,B1,B2,Kd,mode,tau,cc,ebalance_opt_arg);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="comment">%             if ~isnan(x0) &amp;&amp; ~isnan(y0) &amp;&amp; isfinite(x0) &amp;&amp; isfinite(y0)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">                <span class="comment">%solve for Tsfc</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">                <span class="mxinfo " id="T1:U262"><span class="var type1" id="S65T1U461">y</span> = <span class="mxinfo " id="T1:U264"><span class="fcn" id="F767N11:B463">newton_raphson_ebalance</span>(<span class="var type1" id="S64T1U464">x0</span>,<span class="mxinfo " id="T1:U266">single(1e-5)</span>,single(20),<span class="var type1" id="S11T1U471">Lin_coarse</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">                    <span class="var type1" id="S13T1U472">Zdiff</span>,<span class="var type1" id="S15T1U473">T_fine</span>,<span class="var type1" id="S16T1U474">Vf</span>,<span class="var type1" id="S17T1U475">albedo</span>,<span class="var type1" id="S21T1U476">pres_fine</span>,<span class="var type1" id="S18T1U477">Sin</span>,<span class="var type1" id="S39T1U478">ea</span>,<span class="var type1" id="S25T1U479">sig</span>,<span class="var type1" id="S27T5U480">emissivity</span>,<span class="var type1" id="S28T1U481">Cp</span>,<span class="var type1" id="S30T1U482">xLs</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">                    <span class="var type1" id="S32T1U483">rho_air</span>,<span class="var type1" id="S56T1U484">De_h</span>,<span class="var type1" id="S61T1U485">B1</span>,<span class="var type1" id="S62T1U486">B2</span>,<span class="var type1" id="S38T1U487">Kd</span>,<span class="var type1" id="S23T3U488">mode</span>,<span class="var type1" id="S49T1U489">tau</span>,<span class="var type1" id="S51T1U490">cc</span>,<span class="var type1" id="S52T1U491">ebalance_opt_arg</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">                <span class="comment">%use that Tsfc to calculate ebalance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">                <span class="mxinfo " id="T1:U288"><span class="var type1" id="S3T1U494">Tsfc</span> = <span class="var type1" id="S65T1U495">y</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">                <span class="keyword">if</span> <span class="var type1" id="S45T2U499">normalflag</span> &amp;&amp; <span class="mxinfo " id="T2:U292"><span class="var type1" id="S65T1U501">y</span> &gt; <span class="var type1" id="S41T1U502">Tf</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">                    <span class="mxinfo " id="T1:U295"><span class="var type1" id="S3T1U505">Tsfc</span>=<span class="var type1" id="S41T1U506">Tf</span></span>; <span class="comment">%snow temp can't be greater than freezing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">                <span class="comment">%note Tf as input since M is + for y &gt; Tsfc and - for y &lt; Tsfc</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">                [<span class="var type1" id="S2T1U510">M</span>,<span class="var type1" id="S4T1U511">Lin</span>,<span class="var type1" id="S5T1U512">LinZ</span>,<span class="var type1" id="S6T1U513">Lout</span>,<span class="var type1" id="S7T1U514">sensible</span>,<span class="var type1" id="S8T1U515">latent</span>,<span class="var type1" id="S9T1U516">G</span>]=<span class="fcn" id="F803N7:B518">ebalance</span>(<span class="var type1" id="S41T1U519">Tf</span>,<span class="var type1" id="S11T1U520">Lin_coarse</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">                    <span class="var type1" id="S13T1U521">Zdiff</span>,<span class="var type1" id="S15T1U522">T_fine</span>,<span class="var type1" id="S16T1U523">Vf</span>,<span class="var type1" id="S17T1U524">albedo</span>,<span class="var type1" id="S21T1U525">pres_fine</span>,<span class="var type1" id="S18T1U526">Sin</span>,<span class="var type1" id="S39T1U527">ea</span>,<span class="var type1" id="S25T1U528">sig</span>,<span class="var type1" id="S27T5U529">emissivity</span>,<span class="var type1" id="S28T1U530">Cp</span>,<span class="var type1" id="S30T1U531">xLs</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">                    <span class="var type1" id="S32T1U532">rho_air</span>,<span class="var type1" id="S56T1U533">De_h</span>,<span class="var type1" id="S61T1U534">B1</span>,<span class="var type1" id="S62T1U535">B2</span>,<span class="var type1" id="S38T1U536">Kd</span>,<span class="var type1" id="S23T3U537">mode</span>,<span class="var type1" id="S49T1U538">tau</span>,<span class="var type1" id="S51T1U539">cc</span>,<span class="var type1" id="S52T1U540">ebalance_opt_arg</span>);   </span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="comment">%             end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">        <span class="keyword">elseif</span> <span class="var type1" id="S22T2U542">fast_flag</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">            <span class="comment">%just solve using Tf - only the residual M is correct</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">            <span class="mxinfo " id="T1:U328"><span class="var type1" id="S3T1U545">Tsfc</span>=<span class="var type1" id="S41T1U546">Tf</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">            [<span class="var type1" id="S2T1U550">M</span>,<span class="var type1" id="S4T1U551">Lin</span>,<span class="var type1" id="S5T1U552">LinZ</span>,<span class="var type1" id="S6T1U553">Lout</span>,<span class="var type1" id="S7T1U554">sensible</span>,<span class="var type1" id="S8T1U555">latent</span>,<span class="var type1" id="S9T1U556">G</span>]=<span class="fcn" id="F803N7:B558">ebalance</span>(<span class="var type1" id="S3T1U559">Tsfc</span>,<span class="var type1" id="S11T1U560">Lin_coarse</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">                <span class="var type1" id="S13T1U561">Zdiff</span>,<span class="var type1" id="S15T1U562">T_fine</span>,<span class="var type1" id="S16T1U563">Vf</span>,<span class="var type1" id="S17T1U564">albedo</span>,<span class="var type1" id="S21T1U565">pres_fine</span>,<span class="var type1" id="S18T1U566">Sin</span>,<span class="var type1" id="S39T1U567">ea</span>,<span class="var type1" id="S25T1U568">sig</span>,<span class="var type1" id="S27T5U569">emissivity</span>,<span class="var type1" id="S28T1U570">Cp</span>,<span class="var type1" id="S30T1U571">xLs</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">                <span class="var type1" id="S32T1U572">rho_air</span>,<span class="var type1" id="S56T1U573">De_h</span>,<span class="var type1" id="S61T1U574">B1</span>,<span class="var type1" id="S62T1U575">B2</span>,<span class="var type1" id="S38T1U576">Kd</span>,<span class="var type1" id="S23T3U577">mode</span>,<span class="var type1" id="S49T1U578">tau</span>,<span class="var type1" id="S51T1U579">cc</span>,<span class="var type1" id="S52T1U580">ebalance_opt_arg</span>);  </span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"><span class="comment">% end</span></span></span>
</pre>
</body>
</html>
