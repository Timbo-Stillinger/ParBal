<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="78,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">M</span>,<span class="var type1" id="S3T1U4">Lin</span>,<span class="var type1" id="S4T1U5">LinZ</span>,<span class="var type1" id="S5T1U6">Lout</span>,<span class="var type1" id="S6T1U7">sensible</span>,<span class="var type1" id="S7T1U8">latent</span>,<span class="var type1" id="S8T1U9">G</span>]=ebalance(<span class="var type1" id="S9T1U12">Tsfc</span>,<span class="var type1" id="S10T1U13">Lin_coarse</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,2" id="srcline2"> 2</a></span><span class="line">    <span class="var type1" id="S11T1U14">Zdiff</span>,<span class="var type1" id="S12T1U15">T_fine</span>,<span class="var type1" id="S13T1U16">Vf</span>,<span class="var type1" id="S14T1U17">albedo</span>,<span class="var type1" id="S15T1U18">pres_fine</span>,<span class="var type1" id="S16T1U19">Sin</span>,<span class="var type1" id="S17T1U20">ea</span>,<span class="var type2" id="S18T1V3U21">sig</span>,<span class="var type2" id="S19T5V4U22">emissivity</span>,<span class="var type2" id="S20T1V5U23">Cp</span>,<span class="var type2" id="S21T1V6U24">xLs</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,3" id="srcline3"> 3</a></span><span class="line">    <span class="var type1" id="S22T1U25">rho_air</span>,<span class="var type1" id="S23T1U26">De_h</span>,<span class="var type1" id="S24T1U27">B1</span>,<span class="var type1" id="S25T1U28">B2</span>,<span class="var type2" id="S26T1V7U29">Kd</span>,<span class="var type1" id="S27T3U30">mode</span>,<span class="var type1" id="S28T1U31">tau</span>,<span class="var type1" id="S29T1U32">cc</span>,<span class="var type1" id="S30T1U33">opt_arg</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="78,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%incoming longwave</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T1:U30"><span class="var type1" id="S4T1U36">LinZ</span>=<span class="mxinfo " id="T1:U32"><span class="fcn" id="F402N10:B38">lapseLongWave</span>(<span class="var type1" id="S10T1U39">Lin_coarse</span>,<span class="var type1" id="S11T1U40">Zdiff</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% adjust for surrounding terrain, assume snow covered emissivity, but doesn't really</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% matter</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo " id="T1:U35"><span class="var type1" id="S32T1U43">LinT</span> = <span class="mxinfo " id="T1:U37"><span class="mxinfo " id="T1:U38"><span class="var type1" id="S13T1U46">Vf</span>.* <span class="var type1" id="S4T1U47">LinZ</span></span> + <span class="mxinfo " id="T1:U41"><span class="mxinfo " id="T1:U42"><span class="mxinfo " id="T1:U43">(<span class="mxinfo " id="T1:U44">1-<span class="var type1" id="S13T1U54">Vf</span></span>).*<span class="var type1" id="S19T5U56">emissivity</span>.ems</span>.*<span class="var type1" id="S18T1U58">sig</span></span>.*<span class="mxinfo " id="T1:U48"><span class="var type1" id="S9T1U60">Tsfc</span>.^4</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,10" id="srcline10">10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo " id="T6:U50"><span class="keyword">switch</span> <span class="var type1" id="S27T3U63">mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,12" id="srcline12">12</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'normal'</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,13" id="srcline13">13</a></span><span class="line">        <span class="mxinfo " id="T1:U52"><span class="var type1" id="S8T1U68">G</span>=<span class="mxinfo " id="T1:U54">zeros(size(<span class="var type1" id="S10T1U73">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,14" id="srcline14">14</a></span><span class="line">        <span class="mxinfo " id="T1:U56"><span class="var type1" id="S35T1U77">es0</span>=<span class="mxinfo " id="T1:U58"><span class="fcn" id="F509N9:B79">ice_vapor_pressure</span>(<span class="var type1" id="S9T1U80">Tsfc</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,15" id="srcline15">15</a></span><span class="line">        <span class="mxinfo " id="T1:U60"><span class="var type1" id="S21T1U83">xLs</span>=<span class="mxinfo " id="T1:U62">ones(size(<span class="var type1" id="S23T1U89">De_h</span>))*<span class="var type1" id="S21T1U90">xLs</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,16" id="srcline16">16</a></span><span class="line">        <span class="comment">%use latent heat of vaporization instead of sublimation </span></span></span>
<span class="srcline"><span class="lineno"><a href="78,17" id="srcline17">17</a></span><span class="line">        <span class="mxinfo " id="T2:U65"><span class="var type1" id="S38T2U93">ind</span>=<span class="mxinfo " id="T2:U67"><span class="var type1" id="S35T1U95">es0</span>&lt;<span class="var type1" id="S17T1U96">ea</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,18" id="srcline18">18</a></span><span class="line">        <span class="mxinfo " id="T17:U70"><span class="mxinfo " id="T17:U71"><span class="var type1" id="S21T1U100">xLs</span>(<span class="var type1" id="S38T2U101">ind</span>)</span>=<span class="mxinfo " id="T1:U74">2.260e6</span></span>; <span class="comment">%J/kg</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,19" id="srcline19">19</a></span><span class="line">        <span class="comment">% neutral stability for starters, then fill in for unstable/stable</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,20" id="srcline20">20</a></span><span class="line">        <span class="mxinfo " id="T1:U75"><span class="var type1" id="S39T1U105">stability</span> = <span class="mxinfo " id="T1:U77">ones(size(<span class="var type1" id="S10T1U110">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,21" id="srcline21">21</a></span><span class="line">        <span class="comment">% unstable</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,22" id="srcline22">22</a></span><span class="line">        <span class="mxinfo " id="T2:U79"><span class="var type1" id="S38T2U114">ind</span>=<span class="mxinfo " id="T2:U81"><span class="var type1" id="S9T1U116">Tsfc</span> &gt; <span class="var type1" id="S12T1U117">T_fine</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,23" id="srcline23">23</a></span><span class="line">        <span class="mxinfo " id="T17:U84"><span class="var type1" id="S40T17U120">B3</span>= <span class="mxinfo " id="T17:U86">1 + <span class="mxinfo " id="T17:U87"><span class="mxinfo " id="T17:U88"><span class="var type1" id="S25T1U125">B2</span>(<span class="var type1" id="S38T2U126">ind</span>)</span>.*<span class="mxinfo " id="T17:U91">sqrt(<span class="mxinfo " id="T17:U92"><span class="mxinfo " id="T17:U93"><span class="var type1" id="S9T1U131">Tsfc</span>(<span class="var type1" id="S38T2U132">ind</span>)</span>-<span class="mxinfo " id="T17:U96"><span class="var type1" id="S12T1U134">T_fine</span>(<span class="var type1" id="S38T2U135">ind</span>)</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,24" id="srcline24">24</a></span><span class="line">        <span class="mxinfo " id="T17:U99"><span class="mxinfo " id="T17:U100"><span class="var type1" id="S39T1U139">stability</span>(<span class="var type1" id="S38T2U140">ind</span>)</span> = <span class="mxinfo " id="T17:U103">1 + <span class="mxinfo " id="T17:U104"><span class="mxinfo " id="T17:U105"><span class="mxinfo " id="T17:U106"><span class="var type1" id="S24T1U146">B1</span>(<span class="var type1" id="S38T2U147">ind</span>)</span>.*(<span class="mxinfo " id="T17:U109"><span class="mxinfo " id="T17:U110"><span class="var type1" id="S9T1U151">Tsfc</span>(<span class="var type1" id="S38T2U152">ind</span>)</span>-<span class="mxinfo " id="T17:U113"><span class="var type1" id="S12T1U154">T_fine</span>(<span class="var type1" id="S38T2U155">ind</span>)</span></span>)</span>./<span class="var type1" id="S40T17U156">B3</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,25" id="srcline25">25</a></span><span class="line">        <span class="comment">% stable</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,26" id="srcline26">26</a></span><span class="line">        <span class="mxinfo " id="T2:U117"><span class="var type1" id="S38T2U159">ind</span>=<span class="mxinfo " id="T2:U119"><span class="var type1" id="S9T1U161">Tsfc</span> &lt; <span class="var type1" id="S12T1U162">T_fine</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,27" id="srcline27">27</a></span><span class="line">        <span class="mxinfo " id="T17:U122"><span class="var type1" id="S42T17U165">B8</span>=<span class="mxinfo " id="T17:U124"><span class="mxinfo " id="T17:U125"><span class="var type1" id="S24T1U168">B1</span>(<span class="var type1" id="S38T2U169">ind</span>)</span>./2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,28" id="srcline28">28</a></span><span class="line">        <span class="mxinfo " id="T17:U128"><span class="mxinfo " id="T17:U129"><span class="var type1" id="S39T1U174">stability</span>(<span class="var type1" id="S38T2U175">ind</span>)</span> = <span class="mxinfo " id="T17:U132">1./(<span class="mxinfo " id="T17:U133">(<span class="mxinfo " id="T17:U134">1+<span class="mxinfo " id="T17:U135"><span class="var type1" id="S42T17U184">B8</span>.*(<span class="mxinfo " id="T17:U137"><span class="mxinfo " id="T17:U138"><span class="var type1" id="S12T1U188">T_fine</span>(<span class="var type1" id="S38T2U189">ind</span>)</span>-<span class="mxinfo " id="T17:U141"><span class="var type1" id="S9T1U191">Tsfc</span>(<span class="var type1" id="S38T2U192">ind</span>)</span></span>)</span></span>).^2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,30" id="srcline30">30</a></span><span class="line">        <span class="mxinfo " id="T1:U144"><span class="var type1" id="S7T1U196">latent</span>=<span class="mxinfo " id="T1:U146"><span class="mxinfo " id="T1:U147"><span class="mxinfo " id="T1:U148"><span class="mxinfo " id="T1:U149"><span class="var type1" id="S22T1U201">rho_air</span>.*<span class="var type1" id="S21T1U202">xLs</span></span>.*<span class="var type1" id="S23T1U203">De_h</span></span>.*<span class="var type1" id="S39T1U204">stability</span></span>.*(<span class="mxinfo " id="T1:U154">0.622*(<span class="mxinfo " id="T1:U155">(<span class="mxinfo " id="T1:U156"><span class="var type1" id="S17T1U212">ea</span>-<span class="var type1" id="S35T1U213">es0</span></span>)./<span class="var type1" id="S15T1U214">pres_fine</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,31" id="srcline31">31</a></span><span class="line">        <span class="comment">%  adjust for vegetation emitted longwave</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,32" id="srcline32">32</a></span><span class="line">        <span class="mxinfo " id="T1:U160"><span class="var type1" id="S3T1U217">Lin</span> = <span class="mxinfo " id="T1:U162">(<span class="mxinfo " id="T1:U163">(<span class="mxinfo " id="T1:U164"><span class="mxinfo " id="T1:U165"><span class="var type1" id="S28T1U224">tau</span>.*<span class="var type1" id="S32T1U225">LinT</span></span> + <span class="mxinfo " id="T1:U168"><span class="mxinfo " id="T1:U169"><span class="mxinfo " id="T1:U170">(<span class="mxinfo " id="T1:U171">1-<span class="var type1" id="S28T1U232">tau</span></span>).*<span class="var type1" id="S19T5U234">emissivity</span>.emc</span>.*<span class="var type1" id="S18T1U236">sig</span></span>.*<span class="mxinfo " id="T1:U175"><span class="var type1" id="S12T1U238">T_fine</span>.^4</span></span></span>).*<span class="var type1" id="S29T1U240">cc</span></span>)<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,33" id="srcline33">33</a></span><span class="line">            + (<span class="mxinfo " id="T1:U178"><span class="var type1" id="S32T1U243">LinT</span>.*(<span class="mxinfo " id="T1:U180">1-<span class="var type1" id="S29T1U247">cc</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,34" id="srcline34">34</a></span><span class="line">        <span class="mxinfo " id="T1:U182"><span class="var type1" id="S5T1U250">Lout</span> = <span class="mxinfo " id="T1:U184">-(<span class="mxinfo " id="T1:U185"><span class="mxinfo " id="T1:U186"><span class="var type1" id="S19T5U257">emissivity</span>.ems.*<span class="var type1" id="S18T1U259">sig</span>.*<span class="mxinfo " id="T1:U189"><span class="var type1" id="S9T1U261">Tsfc</span>.^4</span></span>+<span class="mxinfo " id="T1:U191">(1-<span class="var type1" id="S19T5U268">emissivity</span>.ems).*<span class="var type1" id="S3T1U270">Lin</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,35" id="srcline35">35</a></span><span class="line">    <span class="keyword">otherwise</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,36" id="srcline36">36</a></span><span class="line">        <span class="mxinfo " id="T1:U194"><span class="var type1" id="S43T1U274">d</span>=<span class="var type1" id="S30T1U275">opt_arg</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,37" id="srcline37">37</a></span><span class="line">        <span class="comment">%Schauwecker et al 2016</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,38" id="srcline38">38</a></span><span class="line">        <span class="mxinfo " id="T1:U197"><span class="var type1" id="S8T1U278">G</span>=<span class="mxinfo " id="T1:U199"><span class="mxinfo " id="T1:U200">-(<span class="mxinfo " id="T1:U201"><span class="var type1" id="S26T1U283">Kd</span>.*(<span class="mxinfo " id="T1:U203"><span class="var type1" id="S9T1U286">Tsfc</span>-273.15</span>)</span>)</span>./(<span class="mxinfo " id="T1:U205">0.5.*<span class="var type1" id="S43T1U291">d</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,39" id="srcline39">39</a></span><span class="line">        <span class="mxinfo " id="T1:U207"><span class="var type1" id="S3T1U294">Lin</span>=<span class="var type1" id="S32T1U295">LinT</span></span>; <span class="comment">% i.e. no veg correction</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,40" id="srcline40">40</a></span><span class="line">        <span class="mxinfo " id="T1:U210"><span class="var type1" id="S5T1U298">Lout</span> = <span class="mxinfo " id="T1:U212">-(<span class="mxinfo " id="T1:U213"><span class="mxinfo " id="T1:U214"><span class="var type1" id="S19T5U305">emissivity</span>.emd.*<span class="var type1" id="S18T1U307">sig</span>.*<span class="mxinfo " id="T1:U217"><span class="var type1" id="S9T1U309">Tsfc</span>.^4</span></span>+<span class="mxinfo " id="T1:U219">(1-<span class="var type1" id="S19T5U316">emissivity</span>.ems).*<span class="var type1" id="S3T1U318">Lin</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,41" id="srcline41">41</a></span><span class="line">        <span class="mxinfo " id="T1:U222"><span class="var type1" id="S39T1U321">stability</span> = <span class="mxinfo " id="T1:U224">ones(size(<span class="var type1" id="S10T1U326">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>; <span class="comment">% Rounce and McKinney 2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,42" id="srcline42">42</a></span><span class="line">        <span class="comment">%assume dry debris</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,43" id="srcline43">43</a></span><span class="line">        <span class="mxinfo " id="T1:U226"><span class="var type1" id="S7T1U330">latent</span>=<span class="mxinfo " id="T1:U228">zeros(size(<span class="var type1" id="S10T1U335">Lin_coarse</span>),<span class="string">'single'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,44" id="srcline44">44</a></span><span class="line"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="78,45" id="srcline45">45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo " id="T1:U230"><span class="var type1" id="S6T1U339">sensible</span>=<span class="mxinfo " id="T1:U232"><span class="mxinfo " id="T1:U233"><span class="mxinfo " id="T1:U234"><span class="mxinfo " id="T1:U235"><span class="var type1" id="S22T1U344">rho_air</span>.*<span class="var type1" id="S20T1U345">Cp</span></span>.*<span class="var type1" id="S23T1U346">De_h</span></span>.*<span class="var type1" id="S39T1U347">stability</span></span>.*(<span class="mxinfo " id="T1:U240"><span class="var type1" id="S12T1U350">T_fine</span>-<span class="var type1" id="S9T1U351">Tsfc</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,47" id="srcline47">47</a></span><span class="line"><span class="mxinfo " id="T1:U243"><span class="var type1" id="S44T1U354">L</span>=<span class="mxinfo " id="T1:U245"><span class="var type1" id="S3T1U356">Lin</span>+<span class="var type1" id="S5T1U357">Lout</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,48" id="srcline48">48</a></span><span class="line"><span class="mxinfo " id="T1:U248"><span class="var type1" id="S45T1U360">T</span>=<span class="mxinfo " id="T1:U250"><span class="var type1" id="S6T1U362">sensible</span>+<span class="var type1" id="S7T1U363">latent</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,49" id="srcline49">49</a></span><span class="line"><span class="comment">% total ebalance</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,50" id="srcline50">50</a></span><span class="line"><span class="mxinfo " id="T1:U253"><span class="var type1" id="S2T1U366">M</span>=<span class="mxinfo " id="T1:U255"><span class="mxinfo " id="T1:U256"><span class="mxinfo " id="T1:U257"><span class="mxinfo " id="T1:U258"><span class="var type1" id="S16T1U371">Sin</span>.*(<span class="mxinfo " id="T1:U260">1-<span class="var type1" id="S14T1U375">albedo</span></span>)</span>+<span class="var type1" id="S44T1U376">L</span></span>+<span class="var type1" id="S45T1U377">T</span></span>+<span class="var type1" id="S8T1U378">G</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,51" id="srcline51">51</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
